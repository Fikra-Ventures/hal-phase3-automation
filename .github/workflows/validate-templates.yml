name: Validate JSON templates

on:
  pull_request:
    paths:
      - "templates/**/*.json"
      - "docs/runbooks/**/*.json"
  push:
    branches: [ main ]
    paths:
      - "templates/**/*.json"
      - "docs/runbooks/**/*.json"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate:
    name: Validate JSON
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Lint JSON files (templates/** and docs/runbooks/**)
        shell: bash
        run: |
          set -euo pipefail

          # Build a null-delimited list of candidate files.
          mapfile -d '' FILES < <( \
            find templates docs/runbooks -type f -name "*.json" -print0 2>/dev/null || true \
          )

          if (( ${#FILES[@]:-0} == 0 )); then
            echo "No JSON files found under templates/** or docs/runbooks/**"
            exit 0
          fi

          echo "Validating ${#FILES[@]} JSON file(s)…"
          for f in "${FILES[@]}"; do
            echo "• $f"
            jq -e . "$f" > /dev/null
          done
          echo "All JSON files are valid."
