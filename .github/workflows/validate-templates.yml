name: Validate n8n Templates

on:
  pull_request:
  workflow_dispatch:

permissions: read-all

jobs:
  validate:
    name: Validate n8n Templates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Detect whether this PR actually touches template/runbook files
      - name: Detect changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            templates:
              - 'templates/**'
              - 'docs/runbooks/**'
              - '.github/workflows/validate-templates.yml'  # always allow self-update

      # If no template files changed, succeed fast
      - name: No template changes â€” skipping validation
        if: steps.changes.outputs.templates != 'true'
        run: |
          echo "No template/runbook files changed in this PR; skipping validation."
          exit 0

      # --- real validation only runs when templates == true ---
      - name: Setup Node
        if: steps.changes.outputs.templates == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install jq
        if: steps.changes.outputs.templates == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Validate JSON schema
        if: steps.changes.outputs.templates == 'true'
        run: |
          echo "ðŸ”Ž Validating template JSON schemas..."
          # Example: fail on first bad JSON file
          find templates docs/runbooks -type f -name '*.json' -print0 | \
            xargs -0 -I{} bash -c 'jq -e . "{}" >/dev/null || (echo "Invalid JSON: {}" && exit 1)'
